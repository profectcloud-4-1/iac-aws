# GitHub Actions: Terraform Cloud 원격 실행 파이프라인
# - PR: fmt/validate + 원격 speculative plan, PR 코멘트로 결과 게시
# - main 푸시: fmt/validate + 원격 apply
# 사전 준비:
# 1) 리포지토리 시크릿에 TF_API_TOKEN(Terraform Cloud User Token) 저장
# 2) Terraform Cloud 워크스페이스 변수(AWS 자격증명 등) 설정
name: Terraform (Remote Execution - Terraform Cloud)

on:
  # PR에서만 plan을 수행하고 결과를 코멘트로 남깁니다.
  pull_request:
    paths:
      - "**/*.tf"
      - "**/*.tfvars"
      - ".github/workflows/terraform-remote.yml"

env:
  # Terraform CLI 비대화/CI 모드 설정
  TF_IN_AUTOMATION: true
  TF_INPUT: false
  # 참고: 아래 값들은 문서화용 환경변수로, 실제 원격 실행은 mian.tf의 cloud 블록을 따릅니다.
  TF_CLOUD_ORGANIZATION: goormdotcom
  TF_WORKSPACE: prod

jobs:
  # 형식 검사(fmt)와 구성 유효성(validate)만 수행하는 기본 검사 잡
  fmt_validate:
    name: fmt & validate
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Terraform CLI 설치 및 Terraform Cloud 인증(토큰은 리포지토리 시크릿 사용)
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      # Terraform Cloud 원격 백엔드로 초기화
      - name: Terraform Init (remote)
        run: terraform init -input=false -no-color

      # 코드 스타일 검사 (변경 사항이 있으면 실패)
      # - name: Terraform Format Check
      #   run: terraform fmt -recursive -check

      # 구성 유효성 검사
      - name: Terraform Validate
        run: terraform validate -no-color

  # PR에서만 실행되는 원격 speculative plan 잡
  plan:
    name: plan (speculative - TFC remote)
    runs-on: ubuntu-latest
    needs: fmt_validate
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Terraform CLI 설치 및 TFC 인증
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      # Terraform Cloud 원격 백엔드로 초기화
      - name: Terraform Init (remote)
        run: terraform init -input=false -no-color

      # 원격 speculative plan 실행(상태 변경 없음)
      - name: Terraform Plan (remote speculative)
        id: plan
        run: |
          set -o pipefail
          terraform plan -no-color -input=false | tee plan.txt

      # plan 결과 파일을 워크플로우 아티팩트로 업로드
      - name: Upload Plan as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: plan.txt
          if-no-files-found: error

      # PR에 plan 결과를 고정(sticky) 코멘트로 게시
      - name: Comment PR with Plan (sticky)
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: terraform-plan
          path: plan.txt

    name: diagram (Terravision)
    runs-on: ubuntu-latest
    needs: fmt_validate
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Python 및 그래프 렌더링 의존성(Graphviz) 설치
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Graphviz
        run: |
          sudo apt-get update
          sudo apt-get install -y graphviz

      # Terravision 설치: 공식 문서 방식 (스크립트 실행)
      - name: Install Terravision (script mode)
        run: |
          pip install --upgrade pip
          git clone --depth 1 https://github.com/patrickchugh/terravision .terravision
          cd .terravision
          pip install -r requirements.txt
          chmod +x terravision.py
          [ -e "$(pwd)/terravision" ] || ln -s "$(pwd)/terravision.py" "$(pwd)/terravision"
          echo "$(pwd)" >> "$GITHUB_PATH"

      # Terraform CLI 설치 (분석용, 백엔드 연결은 비활성화)
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest

      # Terraform 초기화(백엔드 비활성) - 원격 자격증명 없이 동작
      - name: Terraform Init (for analysis)
        run: terraform init -backend=false -input=false -no-color

      # 다이어그램 생성 (SVG 권장: 텍스트 선명, 용량 작음)
      - name: Generate Diagram (SVG)
        run: |
          set -e
          if terravision --help >/dev/null 2>&1; then
            terravision draw --source . --format svg --outfile architecture
          else
            echo "terravision을 찾을 수 없어 terraform graph로 대체합니다."
            terraform graph | dot -Tsvg -Grankdir=LR > architecture.svg
          fi
          test -f "architecture.svg"

      - name: Upload Diagram Artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-diagram
          path: architecture.svg
          if-no-files-found: error

      # PR 코멘트에 다이어그램 링크 남기기 (이미지 인라인은 GitHub 제약으로 외부 호스팅 필요)
      - name: Comment PR with Diagram Link (sticky)
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: terraform-diagram
          message: |
            Terraform 다이어그램이 생성되었습니다.
